<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">

  <!-- https://favicon.io/favicon-generator/ -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <title>Tintin traidingboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: sans-serif;
      font-size: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      grid-gap: 20px;
      align-items: start;
    }
    .grid > article {
      border: 1px solid #ccc;
      box-shadow: 2px 2px 6px 0px  rgba(0,0,0,0.3);
      padding: 20px
    }
    img {
      max-width: 100%;
      max-height: 100%;
      height: 45px;
    }
    .title {
      min-height: 2em;
      text-align: center;
      color: #ccc;
      text-transform: capitalize;
    }
    .price {
      font-size: 18px;
      font-weight: bold;
    }
    a {
      padding-right: 5px;
    }
    .loading a {
      display: none;
    }
    .logo {
      text-align:center;
    }
    .text p {
      text-align: center;
      margin-top: 17px;
      margin-bottom: 17px;
    }
  </style>

  <script type="module">
    import { html, useEffect, useState, render } from 'https://unpkg.com/htm/preact/standalone.module.js'

    const Article = ({ stockId }) => {
      const [info, setInfo] = useState()

      useEffect(async () => {
        async function fetchInfo () {
          const info = await window.getInfo(stockId)
          setInfo(info)
        }

        fetchInfo()
        setInterval(fetchInfo, 20000)
      }, [])

      return html`
        <article class="${info ? '': 'loading'}">
          <div class="logo">
            <img src="https://live.euronext.com/sites/default/files/company_logo/${stockId.substr(0, 12)}.jpg" alt="logo ${info && info.name}" />
            <p class="title">${info ? info.name : '...'}</p>
          </div>
          <div class="text">
            <p><span class="price">${info && info.price} ${info && info.currency}</span> ${info && info.marketStatus}</p>
            <p>${info && info.datetime}</p>

            <p>
              <a target="_blank" href="https://live.euronext.com/en/product/equities/${stockId}">Euronext</a>
              <a target="_blank" href="https://www.boursorama.com/recherche/${stockId.substr(0, 12)}?searchId=">Boursorama</a>
            </p>

          </div>
        </article>
      `
    }

    const App = () => {

    }

    const stockIds = ['FR0013326246-XAMS', 'FR0013379484-XPAR', 'FR0000121725-XPAR', 'FR0000077919-XPAR']

    render(html`<div class="grid">${stockIds.map(stockId => html`<${Article} stockId="${stockId}" />`)}</div>`, document.body)
  </script>

  <script>
    // services
    async function fetchInfo(stockId) {

      console.info(`fetch ${stockId}`)

      const res = await fetch(`https://live.euronext.com/en/ajax/getDetailedQuote/${stockId}`, {
        method: 'POST',
        body: 'theme_name=euronext_live',
        headers: {
          'content-type': 'application/x-www-form-urlencoded; charset=UTF-8',
        },
      })
      if (res.ok) {
       const body = (await res.text()).replace(/(?:\r\n|\r|\n)/g, '')

       let [, name] = /<strong>(.*?)<\/strong>/g.exec(body)
       let [, marketStatus] = /<div class="uppercase font-weight-bold text-uppercase">(.*?)<\/div>/g.exec(body)
       let [, price] = /<span class="data-60" id="header-instrument-price">(.*?)<\/span>/g.exec(body)
       let [, currency] = /<span class="data-50  " id="header-instrument-currency">(.*?)<\/span>/g.exec(body)
       let [datetime] = /[0-3][0-9]\/[0-1][0-9]\/20[2-9][0-9] - [0-2][0-9]:[0-5][0-9](.\s*?)&nbsp;CET/g.exec(body)

       name = name.trim()
       marketStatus = marketStatus.trim()
       currency = currency.trim()
       datetime = datetime.replace('&nbsp;', '').replace(/\s\s+/g, ' ')

       console.info(`${stockId}: ${name} ${price}${currency} ${marketStatus} ${datetime}`)

       return {
         name,
         marketStatus,
         price,
         currency,
         datetime,
        }
      }
    }

    window.getInfo = (stockId) => fetchInfo(stockId)
  </script>
</head>
<body>
</body>
</html>